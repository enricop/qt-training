%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Copyright (c) 2008-2011, Nokia Corporation and/or its subsidiary(-ies).
% All rights reserved.
%
% This work, unless otherwise expressly stated, is licensed under a
% Creative Commons Attribution-ShareAlike 2.5.
%
% The full license document is available from
% http://creativecommons.org/licenses/by-sa/2.5/legalcode .
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Variants}

%----------------------------------------------------------------------
\begin{slide}[fragile]{0238}\frametitle{QVariant}
\begin{itemize}
  \item \iCls{QVariant} 
  \begin{itemize}
    \item Union for common Qt "value types" (copyable, assignable)
    \item Supports implicit sharing (fast copying)
    \item Supports user types
  \end{itemize}\vspace*{3mm}
  \item For \texttt{QtCore} types  
  \item[] \begin{cpp}
QVariant variant(42);
int value = variant.toInt(); // read back
qDebug() << variant.typeName(); // int
\end{cpp}\vspace*{3mm}
\item For non-core and custom types:
  \item[] \begin{cpp}
QVariant variant = QVariant::fromValue(QColor(Qt::red));
QColor color = variant.value<QColor>(); // read back
qDebug() << variant.typeName(); // "QColor"
\end{cpp}\vspace*{3mm}
\item[] \doc{qvariant.html\#details}{QVariant}
\end{itemize}
\end{slide}

%----------------------------------------------------------------------
\begin{slide}[fragile]{0240}
\frametitle{Q\_DECLARE\_METATYPE}
\begin{itemize}
\item[]
\begin{cpp}
#include <QMetaType>

class Contact
{
  public:
    void setName(const QString & name);
    QString name() const;
  ...
};

Q_DECLARE_METATYPE(Contact);
\end{cpp}\vspace*{5mm}
\item Type must support default construction, copy and assignment.
\item Should appear after class definition in header file.
\doc{qmetatype.html\#Q_DECLARE_METATYPE}{Q\_DECLARE\_METATYPE}
\end{itemize}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1254}
\frametitle{Custom Types and QVariant}

\begin{itemize}
\item[]
\begin{cpp}
#include "Contact.h"
#include <QDebug>
#include <QVariant>

int main(int argc, char* argv[])
{
    Contact contact;
    contact.setName("Peter");

    const QVariant variant = QVariant::fromValue(contact);

    const Contact otherContact = variant.value<Contact>();
    qDebug() << otherContact.name(); // "Peter"
    qDebug() << variant.typeName();  // prints "Contact"

    return 0;
}
\end{cpp}
\end{itemize}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1253}
\frametitle{qRegisterMetaType}
\begin{itemize}
\item[]
\begin{cpp}
int main(int argc, char* argv[])
{
    // Register string typename:
    const int typeId = qRegisterMetaType<Contact>();

    Contact contact;
    contact.setName("Peter");

    // Create copy of object in a generic way
    void *object = QMetaType::construct(typeId, &contact);

    Contact *otherContact = reinterpret_cast<Contact*>(object);
    qDebug() << otherContact->name();

    return 0;
}
\end{cpp}
\end{itemize}
\doc{qmetatype.html\#qRegisterMetaType-2}{qRegisterMetaType}
\doc{qmetatype.html\#construct}{construct}
\end{slide}

% ----------------------------------------------------------------------
\subsubsection{Properties}
\begin{slide}[fragile]{2084}
\frametitle{Properties}
\begin{itemize}
  \item Macro for mapping property names to getter/setter functions
\begin{cpp}
  Q_PROPERTY( type name READ getFunction [WRITE setFunction]
  [RESET resetFunction] [NOTIFY notifySignal] [DESIGNABLE bool]
  [SCRIPTABLE bool] [STORED bool] )
\end{cpp}
  \vspace*{0.5em}
  \item An indirect way to call getters/setters of \iCls{QObject}s
\begin{cpp}
  QVariant property(const char* name) const;
  void setProperty(const char* name, const QVariant &value);
\end{cpp}
  \vspace*{0.5em}
  \item If name is not declared as a \texttt{Q\_PROPERTY}
  \begin{itemize}
    \item[] -> \textbf{dynamic property}
  \end{itemize}
  \vspace*{0.5em}
  \item Class-reflection provided by \iCls{QMetaObject} and \iCls{QMetaProperty}
  \vspace*{0.5em}
  \item Note:
  \begin{itemize}
    \item Q\_OBJECT macro required for properties to work
    \item \texttt{QMetaObject} knows nothing about dynamic properties
  \end{itemize}
\end{itemize}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1422}
\frametitle{QObject with Properties Example}
\begin{cpp}
class Customer : public QObject
{
    Q_OBJECT

    Q_PROPERTY(QString id READ getId WRITE setId);
    Q_PROPERTY(QString name READ getName WRITE setName);
    Q_PROPERTY(QString address READ getAddress WRITE setAddress);
    // Read-only
    Q_PROPERTY(QDate dateEstablished READ getDateEstablished );
    Q_PROPERTY(CustomerType type READ getType WRITE setType);

  public:
    enum CustomerType {
      Corporate, Individual, Educational, Government
    };
    Q_ENUMS(CustomerType);
    ...
};
\end{cpp}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1423}
\frametitle{Using Properties}
\begin{itemize}
\item Direct vs indirect setting/getting:
\item[]
\begin{cpp}
Customer customer;

customer.setProperty("name", QString("qt.nokia.com"));
Q_ASSERT(customer.getName() == QString("qt.nokia.com"));

customer.setAddress("54B East Middlesex Turnpike");
const QVariant variant = customer.property("address");
Q_ASSERT(variant.toString() == customer.getAddress());
\end{cpp}
\end{itemize}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1424}
\frametitle{Iterating through properties}
\lstset{basicstyle=\ttfamily\fontsize{9}{9}\selectfont}
\begin{cpp}
QString objToString(const QObject* object)
{
  QStringList result;

  const QMetaObject *metaObject = object->metaObject();
  result += QString("class %1 : public %2 {")
            .arg(metaObject->className())
            .arg(metaObject->superClass()->className());

  for (int i = 0; i < metaObject->propertyCount(); ++i) {
    const QMetaProperty metaProperty = metaObject->property(i);
    const QVariant value = object->property(metaProperty.name());

    result += QString("  %1 %2 = %3;")
              .arg(metaProperty.typeName())
              .arg(metaProperty.name())
              .arg(value.toString());
  }

  result += "};";
  return result.join("\n");
}
\end{cpp}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1425}
\frametitle{Example QObject with properties}
\begin{cpp}
int main (int argc, char* argv[])
{
  QApplication app(argc, argv);

  app.setOrganizationName("nokia");
  app.setApplicationName("testproperties");
  app.setOrganizationDomain("com");

  qDebug() << objToString(&app);
}
\end{cpp}
\demo{coretypes/ex-properties}
\end{slide}

% ----------------------------------------------------------------------
\begin{slide}[fragile]{1426}
\frametitle{Iterating through properties example}
\begin{cpp}
class QApplication : public QCoreApplication {
  QString objectName = ex-properties;
  QString applicationName = testproperties;
  QString applicationVersion = ;
  QString organizationName = nokia;
  QString organizationDomain = com;
  Qt::LayoutDirection layoutDirection = 0;
  int cursorFlashTime = 1000;
  int doubleClickInterval = 400;
  int keyboardInputInterval = 400;
  int wheelScrollLines = 3;
  int startDragTime = 500;
  int startDragDistance = 4;
  bool quitOnLastWindowClosed = true;
  QString styleSheet = ;
  bool autoSipEnabled = true;
};
\end{cpp}
\demo{coretypes/ex-properties}
\end{slide}
